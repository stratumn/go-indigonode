version: v1.0
name: go-node
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804
execution_time_limit:
  minutes: 15

blocks:
  - name: Install and cache tools
    task:
      prologue:
        commands:
          # Go project boiler plate.
          - export "GOPATH=$(go env GOPATH)"
          - export "GOBIN=${GOPATH}/bin"
          - export "PATH=${GOBIN}:${PATH}"
          - export "SEMAPHORE_GIT_DIR=${GOPATH}/src/github.com/stratumn/go-node"
          - mkdir -vp "${SEMAPHORE_GIT_DIR}"
      jobs:
        - name: Install and cache Go tools
          commands:
            - cd $GOPATH
            # Only update binaries once a month.
            - KEY=gotools-$(date +%Y%m)-v1
            - cache has_key "$KEY" || mkdir -vp "${GOBIN}"
            - cache restore "$KEY"
            - cache has_key "$KEY" || go get -u github.com/golang/dep/cmd/dep
            - cache has_key "$KEY" || go get -u github.com/whyrusleeping/gx
            - cache has_key "$KEY" || go get -u github.com/whyrusleeping/gx-go
            - cache has_key "$KEY" || go get -u github.com/golangci/golangci-lint/cmd/golangci-lint
            # Cache everything in $GOPATH/bin.
            - cache store "$KEY" bin

  - name: Warm cache
    task:
      prologue:
        commands:
          # Go project boiler plate.
          - export "GOPATH=$(go env GOPATH)"
          - export "GOBIN=${GOPATH}/bin"
          - export "PATH=${GOBIN}:${PATH}"
          - export "SEMAPHORE_GIT_DIR=${GOPATH}/src/github.com/stratumn/go-node"
          - mkdir -vp "${SEMAPHORE_GIT_DIR}"
          # Load Go tools from cache.
          - cd $GOPATH
          - cache restore gotools-$(date +%Y%m)-v1
          - cd $SEMAPHORE_GIT_DIR
          # Git checkout.
          - checkout
      jobs:
        - name: Warm deps
          commands:
            - export "KEY=deps-$(checksum Gopkg.lock)-v1"
            - cache restore "$KEY"
            - cache has_key "$KEY" || dep ensure -v
            - cache store $KEY vendor
        - name: Warm gx
          commands:
            # Cache $GOPATH/src/gx.
            - export "KEY=gx-$(checksum package.json)-v1"
            - cache has_key "$KEY" || gx install
            - cd ${GOPATH}/src
            - cache store "$KEY" gx

  - name: Lint and test
    task:
      prologue:
        commands:
          # Go project boiler plate.
          - export "GOPATH=$(go env GOPATH)"
          - export "GOBIN=${GOPATH}/bin"
          - export "PATH=${GOBIN}:${PATH}"
          - export "SEMAPHORE_GIT_DIR=$GOPATH/src/github.com/stratumn/go-node"
          - mkdir -vp "${SEMAPHORE_GIT_DIR}"
          # Load Go tools from cache.
          - cd $GOPATH
          - cache restore gotools-$(date +%Y%m)-v1
          - cd $SEMAPHORE_GIT_DIR
          # Git checkout.
          - checkout
          # Restore caches.
          - cache restore deps-$(checksum Gopkg.lock)-v1
          - export "KEY=gx-$(checksum package.json)-v1"
          - cd ${GOPATH}/src
          - cache restore "$KEY"
          - cd $SEMAPHORE_GIT_DIR
          # Other tasks.
          - make --touch protobuf
      secrets:
        - name: go-node-codecov
      jobs:
      - name: Lint
        commands:
          - make lint
      - name: Run unit tests
        commands:
          - make coverage
          - bash <(curl -s https://codecov.io/bash) -t $CODECOV_TOKEN
      - name: Run system tests
        commands:
          - make install
          - make system
