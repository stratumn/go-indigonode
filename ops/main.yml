- hosts: localhost
  connection: local
  gather_facts: False
  vars:
    # Amazon image (AMI) of Ubuntu 16.04
    instance_ids:
      - i-08c080a0f545388d5
      - i-0dcb99d836b87a375
  tasks:
  - name: Provision a set of instances
    ec2:
        key_name: "{{ aws_key_pair }}"
        group: "{{ aws_security_group }}"
        instance_type: "{{ aws_instance_type }}"
        region: "{{ aws_region }}"
        image: "{{ aws_image }}"
        wait: true
        count: "{{ node_count }}"
    register: ec2

  # - name: Start the instances
  #   ec2:
  #     instance_ids: "{{ instance_ids }}"
  #     region: "{{ aws_region }}"
  #     state: running
  #     wait: True
  #     assign_public_ip: yes
  #   register: ec2

  - name: Add all instance public IPs to host group
    add_host:
      hostname: "{{ item.public_ip }}"
      groupname: ec2hosts
    with_items: "{{ ec2.instances }}"

  - name: Wait for SSH to come up
    wait_for:
      host: "{{ item.public_dns_name }}"
      port: 22
      delay: 20
      timeout: 320
      state: started
    with_items: "{{ ec2.instances }}"

- name: Install python
  hosts: ec2hosts
  become: True
  gather_facts: no
  tasks:
    # Needed in Ubuntu 16.04 (that bundles python3)
    - name: Install python2
      raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)

- name: Configure instance(s)
  hosts: ec2hosts
  gather_facts: True
  roles:
    - nodes

# - name: Terminate instance(s)
#   hosts: localhost
#   connection: local
#   tasks:
#   - name: Terminate instances that were previously launched
#     ec2:
#       state: 'absent'
#       region: eu-west-2
#       instance_ids: '{{ ec2.instance_ids }}'