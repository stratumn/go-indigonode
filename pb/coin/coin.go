// Copyright Â© 2017-2018 Stratumn SAS
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package coin

import "errors"

// The goal of this file is to enrich the model generated by protoc.

var (
	// ErrBadResponseType is returned when a call to a peer returns an
	// unexpected response type.
	ErrBadResponseType = errors.New("bad response type")
)

// BlockNumber returns the number of a block.
func (b *Block) BlockNumber() uint64 {
	if b.Header == nil {
		return 0
	}
	return b.Header.BlockNumber
}

// PreviousHash returns the hash of previous block's header.
func (b *Block) PreviousHash() []byte {
	if b.Header == nil {
		return []byte{}
	}
	return b.Header.PreviousHash
}

// Nonce returns the nonce of the block's header.
func (b *Block) Nonce() uint64 {
	if b.Header == nil {
		return 0
	}
	return b.Header.Nonce
}

// NewHeaderRequest returns a request object of type HeaderReq.
func NewHeaderRequest(hash []byte) *Request {
	return &Request{
		Msg: &Request_HeaderReq{
			HeaderReq: &HeaderRequest{Hash: hash},
		},
	}
}

// GetHeader returns the Header of a HeaderRsp or fails
// for other response types.
func (rsp *Response) GetHeader() (*Header, error) {
	h, ok := rsp.Msg.(*Response_HeaderRsp)
	if !ok {
		return nil, ErrBadResponseType
	}

	return h.HeaderRsp, nil
}

// NewHeaderResponse returns a response object of type HeaderRsp.
func NewHeaderResponse(header *Header) *Response {
	return &Response{
		Msg: &Response_HeaderRsp{
			HeaderRsp: header,
		},
	}
}

// NewHeadersRequest returns a request object of type HeadersReq.
func NewHeadersRequest(from, amount uint64) *Request {
	return &Request{
		Msg: &Request_HeadersReq{
			HeadersReq: &HeadersRequest{From: from, Amount: amount},
		},
	}
}

// GetHeaders returns the Headers of a HeadersRsp or fails
// for other response types.
func (rsp *Response) GetHeaders() ([]*Header, error) {
	h, ok := rsp.Msg.(*Response_HeadersRsp)
	if !ok {
		return nil, ErrBadResponseType
	}

	return h.HeadersRsp.Headers, nil
}

// NewHeadersResponse returns a response object of type HeadersRsp.
func NewHeadersResponse(headers []*Header) *Response {
	return &Response{
		Msg: &Response_HeadersRsp{
			HeadersRsp: &Headers{Headers: headers},
		},
	}
}

// NewBlockRequest returns a request object of type BlockReq.
func NewBlockRequest(hash []byte) *Request {
	return &Request{
		Msg: &Request_BlockReq{
			BlockReq: &BlockRequest{Hash: hash},
		},
	}
}

// GetBlock returns the Block of a BlockRsp or fails
// for other response types.
func (rsp *Response) GetBlock() (*Block, error) {
	h, ok := rsp.Msg.(*Response_BlockRsp)
	if !ok {
		return nil, ErrBadResponseType
	}

	return h.BlockRsp, nil
}

// NewBlockResponse returns a response object of type BlockRsp.
func NewBlockResponse(header *Block) *Response {
	return &Response{
		Msg: &Response_BlockRsp{
			BlockRsp: header,
		},
	}
}

// NewBlocksRequest returns a request object of type BlocksReq.
func NewBlocksRequest(from, amount uint64) *Request {
	return &Request{
		Msg: &Request_BlocksReq{
			BlocksReq: &BlocksRequest{From: from, Amount: amount},
		},
	}
}

// GetBlocks returns the Blocks of a BlocksRsp or fails
// for other response types.
func (rsp *Response) GetBlocks() ([]*Block, error) {
	h, ok := rsp.Msg.(*Response_BlocksRsp)
	if !ok {
		return nil, ErrBadResponseType
	}

	return h.BlocksRsp.Blocks, nil
}

// NewBlocksResponse returns a response object of type BlocksRsp.
func NewBlocksResponse(headers []*Block) *Response {
	return &Response{
		Msg: &Response_BlocksRsp{
			BlocksRsp: &Blocks{Blocks: headers},
		},
	}
}
